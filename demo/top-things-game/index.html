<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="viewport" content="width=600"/>
    <meta name="viewport" content="user-scalable=no,target-densitydpi=device-dpi">
    <title>顶东西</title>
    <link rel="stylesheet" href="css.css"/>
</head>
<body>
<div id="game-wrapper">
    <div id="game-hit-container">
        <span id="game-thins-container"></span>
    </div>

    <span id="game-guys"></span>

    <div id="game-time-container">
        <div id="game-time-tips"><span id="game-time-left">15</span><b style="font-size: 42px">秒</b></div>
    </div>

    <div id="game-Bingo-list">

    </div>

    <div class="game-dialog" id="game-dialog-success">
        <div class="sprites-success"></div>

        <div class="text">哇哦，<br>3枚芒果集齐啦!!<br><b class="btn reset-game">再来一次</b>
        </div>
    </div>

    <div class="game-dialog" id="game-dialog-fail">
        <div class="sprites_fail"></div>

        <div class="text">时间到，<br>
            未能完成任务！<br>
            <b class="btn reset-game">重来</b>
        </div>
    </div>

    <div class="game-dialog" id="game-dialog-start" style="z-index: 1">
        <div class="sprites-success"></div>

        <div class="text">15秒内<br>集齐3个芒果<br><b class="btn" id="game-start-btn">点击开始</b>
        </div>
    </div>

</div>

<script src="http://a.tbcdn.cn/s/kissy/1.3.0/kissy-min.js"></script>
<script>

    var arr = [
        {"name": "芒果"},
        {"name": "大白兔奶糖"},
        {"name": "大大泡泡堂"},
        {"name": "雪糕"},
        {"name": "无花果"},
        {"name": "小浣熊"}
    ];

    KISSY.ready(function (S) {
        var DOM = S.DOM, Event = S.Event;
        var wrapper = DOM.get('#game-wrapper');
        var guys = DOM.get('#game-guys');
        var hit = DOM.get('#game-hit-container');
        var thins = DOM.get('#game-thins-container');
        var bingo = DOM.get('#bingo');
        var bingoContainer = DOM.get('#game-Bingo-list');
        var gameTimeLeft = DOM.get('#game-time-left');
        var bingoImg = document.getElementById('game-Bingo-list').getElementsByTagName('span');
        var timerDefault = 15;
        var timer = timerDefault;
        var timer_cl;
        var resetGame = DOM.query('b.reset-game');
        //集齐多少个芒果
        var sum = 3;

        var obj = new switchThins();

        var isRuning = false;

        function switchBingo() {
            if (isRuning) return;
            isRuning = true;
            S.Anim(guys, {top: 160}, .2, 'easeIn',function () {
                Bingo();
                S.Anim(hit, {marginTop: '-20px'}, .1, 'easeNone',function () {
                    S.Anim(hit, {marginTop: '-0'}, .1, 'easeNone').run();
                }).run();
                S.Anim(guys, {top: 495}, .2, 'easeInStrong',function () {
                    setTimeout(function () {
                        isRuning = false;
                    }, 460);
                }).run()
            }).run()
        }

        //切换各种道具，时间越快难度越大
        function switchThins() {
            this.index = 0;
            var self = this;
            var cl;
            this.run = function () {
                self.index++;
                if (self.index > arr.length - 1) self.index = 0;
                thins.className = "sprites_binggo_" + (self.index + 1);
                cl = setTimeout(self.run, 500);
            };

            this.getIndex = function () {
                return self.index;
            };

            this.stop = function () {
                clearTimeout(cl);
            }
        }

        //当点击开始游戏按钮时
        Event.on('#game-start-btn', 'touchstart', function () {
            //隐藏所有浮层
            DOM.css('.game-dialog ', 'z-index', '-1');
            obj.run();
            Event.on(document.body, 'touchstart', switchBingo);
            timeLeft();
        });

        //当点击重来的时候
        Event.on(resetGame, 'touchstart', function () {
            DOM.css('.game-dialog ', 'z-index', '-1');

            //一些必要的清理
            clear();
            bingoContainer.innerHTML = '';

            //重新开始切换道具
            obj.run();

            //重新绑定事件
            Event.on(document.body, 'touchstart', switchBingo);

            //重新设定倒计时
            timer = timerDefault;
            timeLeft();
        });

        //倒计时
        function timeLeft() {
            if (timer >= 0) timer_cl = setTimeout(timeLeft, 1000);
            gameTimeLeft.innerHTML = timer.toString();
            timer--;
            if (timer < 0) {
                clear();
                if (bingoImg.length < sum) {
                    DOM.css('#game-dialog-fail', 'z-index', '1');
                }
            }
        }

        function clear() {
            obj.stop();
            clearTimeout(timer_cl);
            Event.detach(document.body, 'touchstart', switchBingo);
        }


        //显示当前中了什么奖励
        function Bingo() {
            var index = obj.getIndex();
            if (arr[index].name === '芒果') addBingoList();
            var a = 40;
            for (var i = 0; i < 5; i++) {
                (function (i) {
                    var img = document.createElement('span');
                    img.className = 'current_things sprites_binggo_' + (index + 1);
                    var id = 'Bingo' + parseInt(Math.random() * 1000000, 10);
                    img.id = id;
                    img.style.transform = "rotate(12deg,33deg)";

                    var a = 20;
                    var b = 80;

                    DOM.css(img, {'-webkit-transform': 'rotate(' + parseInt(Math.random() * 360, 10) + 'deg) scale(1.1)'})
                    wrapper.appendChild(img);
                    img = DOM.get('#' + id);
                    S.Anim(img, {top: '0', left: parseInt(Math.random() * 100, 10) % (b - a + 1) + a + '%'}, .4, 'easeOut',function () {
                        S.Anim(img, {
                            top: '600',
                            opacity: 0
                        }, .6, 'easeInStrong',function () {
                            DOM.remove(img);
                        }).run();
                    }).run();
                })(i);
            }
        }

        function addBingoList() {
            if (bingoImg.length < sum) {
                bingoContainer.innerHTML += '<span class="sprites_binggo_1"></span>';
                if (bingoImg.length >= sum) {
                    clear();
                    DOM.css('#game-dialog-success', 'z-index', '1');
                }
            }
        }
    });

    KISSY.io({
        url: "http://count.tbcdn.cn/counter3",
        dataType: 'jsonp',
        data: {
            inc: "JUCENTER_779_juact528m",
            sign: '99158e59d4b79d305e5ddd0c9ca019d926c',
            keys: 'JUCENTER_779_juact528m'
        }
    })
</script>
</body>
</html>
