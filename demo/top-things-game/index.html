<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=600"/>
<meta name="viewport" content="user-scalable=no,target-densitydpi=device-dpi">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>顶芒果</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #ffcb51;
}

#game-wrapper {
    width: 600px;
    margin: 0 auto;
    height: 760px;
    position: relative;
    background: url(http://img01.taobaocdn.com/tps/i1/T14jmSXDFhXXabVyYF-610-800.jpg) center 0 repeat-x;
    overflow: hidden;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    tap-highlight-color: rgba(0, 0, 0, 0);
    outline: none;
}

#game-hit-container {
    margin: 0 auto;
    background: url(http://img02.taobaocdn.com/tps/i2/T1GyqSXvliXXXTa_6h-990-900.png) -667px -300px no-repeat;
    width: 300px;
    height: 103px;
    position: relative;
    top: 130px;
    z-index: 3;
}

#game-guys {
    position: absolute;
    left: 50%;
    margin-left: -82px;
    top: 495px;
    background: url(http://img02.taobaocdn.com/tps/i2/T1GyqSXvliXXXTa_6h-990-900.png) -234px -253px no-repeat;
    height: 216px;
    width: 165px;
}

#game-thins-container {
    margin-left: 100px;
}

.Bingo {
    position: absolute;
    width: 100px;
    height: 100px;
    left: 50%;
    margin-left: -50px;
    top: 129px;
}

#game-time-container {
    position: absolute;
    right: 12px;
    top: 12px;
    color: yellow;
    font-family: verdana, "Microsoft Yahei", sans-serif;
    font-size: 82px;
    z-index: 3;
}

#game-Bingo-list {
    position: absolute;
    left: 12px;
    top: 12px;
    height: 100px;
    white-space: nowrap;
}

#game-Bingo-list span {
    float: left;
}

.game-dialog {
    position: absolute;
    left: 33%;
    top: 50%;
    margin-top: -171px;
    margin-left: -172px;
    background: url("http://img02.taobaocdn.com/tps/i2/T1GyqSXvliXXXTa_6h-990-900.png") 0 -555px no-repeat;
    width: 600px;
    height: 347px;
    z-index: -1;
}

.game-dialog div.text {
    position: absolute;
    left: 146px;
    top: 61px;
    color: #fff;
    font-size: 44px;
    line-height: 180%;
}

.btn {
    background: yellow;
    padding: 5px;
    color: #a00;
    cursor: pointer;
    border-radius: 4px;
    font-weight: bold;
    text-decoration: none;
}

.sprites_binggo_1,
.sprites_binggo_2,
.sprites_binggo_3,
.sprites_binggo_4,
.sprites_binggo_5,
.sprites_binggo_6 {
    background: url(http://img02.taobaocdn.com/tps/i2/T1GyqSXvliXXXTa_6h-990-900.png);
    display: block;
    width: 100px;
    height: 100px;
    overflow: hidden;

}

.sprites_binggo_1 {
    background-position: 0 0;
}

.sprites_binggo_2 {
    background-position: -166px 0;
}

.sprites_binggo_3 {
    background-position: -344px 0;
}

.sprites_binggo_4 {
    background-position: -538px 0;
}

.sprites_binggo_5 {
    background-position: -672px 0;
}

.sprites_binggo_6 {
    background-position: -817px 0;
}

.current_things {
    position: absolute;
    left: 50%;
    margin-left: -50px;
    z-index: 4;
}

.sprites_fail,
.sprites-success,
.sprites_fail {
    background: url(http://img02.taobaocdn.com/tps/i2/T1GyqSXvliXXXTa_6h-990-900.png) 0 -253px no-repeat;
    position: absolute;
    left: -24px;
    top: 65px;
    width: 167px;
    height: 218px;
}

.sprites-success {
    background-position: -431px -253px;
}

@-webkit-keyframes cloud {
    0% {
        left: -200px;
    }

    50% {
        left: 300px;
    }

    100% {
        left: 800px;
    }
}

@keyframes cloud {

    0% {
        left: -200px;
    }

    50% {
        left: 300px;
    }

    100% {
        left: 800px;
    }
}

.cloud {
    -webkit-animation: cloud 23s 1 linear;
    animation: cloud 23s 1 linear;
    position: absolute;
    top: 0;
    background: url(http://img03.taobaocdn.com/tps/i3/T1eZaUXEheXXXu792p-84-59.png);
    width: 84px;
    height: 59px;
}
</style>
</head>
<body>
<div id="game-wrapper">

    <div id="game-hit-container">
        <span id="game-thins-container"></span>
    </div>

    <span id="game-guys"></span>

    <div id="game-time-container">
        <div id="game-time-tips"><span id="game-time-left">30</span><b style="font-size: 42px">秒</b></div>
    </div>

    <div id="game-Bingo-list">

    </div>

    <div class="game-dialog" id="game-dialog-success">
        <div class="sprites-success"></div>

        <div class="text" style="font-size: 26px;width: 360px;">5枚芒果集齐啦!!<br><br><span id="J-flash-tips">这次游戏将会为雅安的孩子，<b
                style="color:yellow;">募得芒果V基金会提供的5元资金，谢谢您。</b></span><b
                onclick="document.getElementById('J-flash-tips').style.display='none'" class="btn reset-game">再来一次</b>
        </div>
    </div>

    <div class="game-dialog" id="game-dialog-fail">
        <div class="sprites_fail"></div>

        <div class="text">时间到，<br>
            未能完成任务！<br>
            <b class="btn reset-game">重来</b>
        </div>
    </div>

    <div class="game-dialog" id="game-dialog-start" style="z-index: 3">
        <div class="sprites-success"></div>
        <div class="text" style="font-size: 22px;top:54px;width: 360px;">光影童年，用我们的爱心为雅安的孩子创造一个快乐童年；每个用户玩一次游戏，<b
                style="color:yellow;">芒果V基金即捐赠5元</b>。<br>
            <strong style="font-size: 26px;">游戏目标：集齐<span style="font-size: 40px;color:yellow;">5枚</span>芒果！<br><b
                    class="btn" id="game-start-btn" style="padding: 12px 12px;display: inline-block;">点击开始</b></strong>
        </div>
    </div>
</div>

</div>

<script src="http://a.tbcdn.cn/s/kissy/1.3.0/kissy-min.js"></script>
<script>

    var arr = [
        {"name": "芒果"},
        {"name": "大白兔奶糖"},
        {"name": "大大泡泡堂"},
        {"name": "雪糕"},
        {"name": "无花果"},
        {"name": "小浣熊"}
    ];

    KISSY.ready(function (S) {
        var DOM = S.DOM, Event = S.Event;
        var wrapper = DOM.get('#game-wrapper');
        var guys = DOM.get('#game-guys');
        var hit = DOM.get('#game-hit-container');
        var thins = DOM.get('#game-thins-container');
        var bingo = DOM.get('#bingo');
        var bingoContainer = DOM.get('#game-Bingo-list');
        var gameTimeLeft = DOM.get('#game-time-left');
        var bingoImg = document.getElementById('game-Bingo-list').getElementsByTagName('span');
        var timerDefault = 30;
        var timer = timerDefault;
        var timer_cl;
        var resetGame = DOM.query('b.reset-game');
        //集齐多少个芒果
        var sum = 5;

        var obj = new switchThins();

        var isRuning = false;

        function switchBingo() {
            if (isRuning) return;
            isRuning = true;
            S.Anim(guys, {top: 160}, .2, 'easeIn',function () {
                Bingo();
                S.Anim(hit, {marginTop: '-20px'}, .1, 'easeNone',function () {
                    S.Anim(hit, {marginTop: '-0'}, .1, 'easeNone').run();
                }).run();
                S.Anim(guys, {top: 495}, .2, 'easeInStrong',function () {
                    setTimeout(function () {
                        isRuning = false;
                    }, 760);
                }).run()
            }).run()
        }

        //切换各种道具，时间越快难度越大
        function switchThins() {
            this.index = 0;
            var self = this;
            var cl;
            this.run = function () {
                self.index++;
                if (self.index > arr.length - 1) self.index = 0;
                thins.className = "sprites_binggo_" + (self.index + 1);
                cl = setTimeout(self.run, 450);
            };

            this.getIndex = function () {
                return self.index;
            };

            this.stop = function () {
                clearTimeout(cl);
            }
        }

        //当点击开始游戏按钮时
        Event.on('#game-start-btn', 'touchstart', function () {
            //隐藏所有浮层
            DOM.css('.game-dialog ', 'z-index', '-1');
            obj.run();
            Event.on(document.body, 'touchstart', switchBingo);
            timeLeft();
        });

        //当点击重来的时候
        Event.on(resetGame, 'touchstart', function () {
            DOM.css('.game-dialog ', 'z-index', '-1');

            //一些必要的清理
            clear();
            bingoContainer.innerHTML = '';

            //重新开始切换道具
            obj.run();

            //重新绑定事件
            Event.on(document.body, 'touchstart', switchBingo);

            //重新设定倒计时
            timer = timerDefault;
            timeLeft();
        });

        //倒计时
        function timeLeft() {
            if (timer >= 0) timer_cl = setTimeout(timeLeft, 1000);
            gameTimeLeft.innerHTML = timer.toString();
            timer--;
            if (timer < 0) {
                clear();
                if (bingoImg.length < sum) {
                    DOM.css('#game-dialog-fail', 'z-index', '3');
                }
            }
        }

        function clear() {
            obj.stop();
            clearTimeout(timer_cl);
            Event.detach(document.body, 'touchstart', switchBingo);
        }


        //显示当前中了什么奖励
        function Bingo() {
            var index = obj.getIndex();
            if (arr[index].name === '芒果') addBingoList();
            for (var i = 0; i < 5; i++) {
                (function () {
                    var img = document.createElement('span');
                    img.className = 'current_things sprites_binggo_' + (index + 1);
                    var id = 'Bingo' + parseInt(Math.random() * 1000000, 10);
                    img.id = id;
                    img.style.transform = "rotate(12deg,33deg)";

                    var a = 20;
                    var b = 80;

                    DOM.css(img, {'-webkit-transform': 'rotate(' + parseInt(Math.random() * 360, 10) + 'deg) scale(1.1)'})
                    wrapper.appendChild(img);
                    img = DOM.get('#' + id);
                    S.Anim(img, {top: '0', left: parseInt(Math.random() * 100, 10) % (b - a + 1) + a + '%'}, .4, 'easeOut',function () {
                        S.Anim(img, {
                            top: '600',
                            opacity: 0
                        }, .6, 'easeInStrong',function () {
                            DOM.remove(img);
                        }).run();
                    }).run();
                })();
            }
        }

        function addBingoList() {
            if (bingoImg.length < sum) {
                bingoContainer.innerHTML += '<span class="sprites_binggo_1"></span>';
                if (bingoImg.length >= sum) {
                    clear();
                    DOM.css('#game-dialog-success', 'z-index', '3');
                }
            }
        }

        Event.on(window, 'load', function () {
            function cloud() {
                var id = 'cloud' + Date.now();
                var cloud = document.createElement('div');
                cloud.id = id;
                cloud.className = 'cloud';
                cloud.style.zoom = Math.random() > .5 ? 1 : 2 + '.' + parseInt(Math.random() * 10, 10);
                cloud.style.top = parseInt(Math.random() * 50, 10) + 'px';
                wrapper.appendChild(cloud)
                setTimeout(function () {
                    DOM.remove('#' + id);
                }, 20000)
            }

            cloud();
            setInterval(cloud, 2000)
        })
    });

    KISSY.io({
        url: "http://count.tbcdn.cn/counter3",
        dataType: 'jsonp',
        data: {
            inc: "JUCENTER_779_juact528m",
            sign: '99158e59d4b79d305e5ddd0c9ca019d926c',
            keys: 'JUCENTER_779_juact528m'
        }
    })


</script>
</body>
</html>
